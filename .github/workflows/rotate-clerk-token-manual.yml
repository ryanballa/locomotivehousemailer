name: Manual Clerk Token Rotation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rotate token for'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - production

jobs:
  manual-rotate:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Validate secrets
        run: |
          echo "Checking for CLERK_SECRET_KEY..."
          if [ -z "${{ secrets.CLERK_SECRET_KEY }}" ]; then
            echo "❌ Error: CLERK_SECRET_KEY secret is not set"
            echo "Available secrets context keys:"
            echo "${{ toJSON(secrets) }}" | grep -o '"[^"]*":' | head -20
            exit 1
          fi
          echo "✓ CLERK_SECRET_KEY is set"

          echo "Checking for SERVICE_USER_ID..."
          if [ -z "${{ secrets.SERVICE_USER_ID }}" ]; then
            echo "❌ Error: SERVICE_USER_ID secret is not set"
            exit 1
          fi
          echo "✓ SERVICE_USER_ID is set"

          echo "✓ All required secrets are configured"

      - name: Generate new token
        id: generate
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          SERVICE_USER_ID: ${{ secrets.SERVICE_USER_ID }}
        run: |
          cat > generate-token.mjs << 'EOF'
          import { createClerkClient } from '@clerk/backend';
          import { writeFileSync } from 'fs';

          async function main() {
            const clerkSecretKey = process.env.CLERK_SECRET_KEY;
            const serviceUserId = process.env.SERVICE_USER_ID;

            if (!clerkSecretKey) {
              throw new Error('Missing Clerk Secret Key - CLERK_SECRET_KEY environment variable not set');
            }

            if (!serviceUserId) {
              throw new Error('Missing Service User ID - SERVICE_USER_ID environment variable not set');
            }

            console.log('Creating Clerk client...');
            const clerk = createClerkClient({
              secretKey: clerkSecretKey
            });

            // Step 1: Create a session for the service user
            console.log('Creating session for user:', serviceUserId);
            const sessionData = await clerk.sessions.createSession({
              userId: serviceUserId
            });

            console.log('Session created:', sessionData.id);

            // Step 2: Get a token from that session
            console.log('Generating token...');
            const token = await clerk.sessions.getToken(
              sessionData.id,
              undefined,
              2592000
            );

            if (!token || !token.jwt) {
              throw new Error('No token returned from Clerk API');
            }

            console.log('✓ Token generated successfully');

            // Write to GitHub output file
            writeFileSync(process.env.GITHUB_OUTPUT, `NEW_TOKEN=${token.jwt}\n`, { flag: 'a' });
          }

          main().catch(e => {
            console.error('Error:', e.message);
            process.exit(1);
          });
          EOF

          npm install @clerk/backend
          node generate-token.mjs

      - name: Update Cloudflare Secret
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEW_TOKEN: ${{ steps.generate.outputs.NEW_TOKEN }}
        run: |
          # Update via wrangler
          echo "${{ steps.generate.outputs.NEW_TOKEN }}" | wrangler secret put CLERK_REFRESH_TOKEN --env ${{ github.event.inputs.environment }}

      - name: Redeploy Worker
        if: success()
        run: |
          npm install
          npm run deploy

      - name: Notify on Success
        if: success()
        run: |
          echo "✓ Token rotated and worker redeployed"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Expires: $(date -u -d '+30 days' +'%Y-%m-%dT%H:%M:%SZ')"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "✗ Token rotation failed"
          echo "Check logs for details"
          exit 1
