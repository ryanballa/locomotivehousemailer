name: Manual Clerk Token Rotation

on:
  workflow_dispatch:

jobs:
  manual-rotate:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Validate secrets
        run: |
          echo "Checking for CLERK_SECRET_KEY..."
          if [ -z "${{ secrets.CLERK_SECRET_KEY }}" ]; then
            echo "❌ Error: CLERK_SECRET_KEY secret is not set"
            echo "Available secrets context keys:"
            echo "${{ toJSON(secrets) }}" | grep -o '"[^"]*":' | head -20
            exit 1
          fi
          echo "✓ CLERK_SECRET_KEY is set"

          # Show first few characters to verify it's a production key
          KEY="${{ secrets.CLERK_SECRET_KEY }}"
          echo "Key type: ${KEY:0:8}..."
          if [[ $KEY == sk_live_* ]]; then
            echo "✓ Using PRODUCTION Clerk key"
          elif [[ $KEY == sk_test_* ]]; then
            echo "⚠ WARNING: Using TEST/DEVELOPMENT Clerk key (should use sk_live_)"
          fi

          echo "Checking for SERVICE_USER_ID..."
          if [ -z "${{ secrets.SERVICE_USER_ID }}" ]; then
            echo "❌ Error: SERVICE_USER_ID secret is not set"
            exit 1
          fi
          echo "✓ SERVICE_USER_ID is set"

          echo "✓ All required secrets are configured"

      - name: Check key type
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
        run: |
          # Extract first 8 characters to check key type
          KEY_PREFIX=$(echo "$CLERK_SECRET_KEY" | cut -c1-8)
          echo "Secret key prefix: $KEY_PREFIX"
          if [[ "$KEY_PREFIX" == "sk_live_" ]]; then
            echo "✓ Using PRODUCTION Clerk key (sk_live_)"
          elif [[ "$KEY_PREFIX" == "sk_test_" ]]; then
            echo "⚠ WARNING: Using TEST/DEVELOPMENT Clerk key (sk_test_)"
            echo "This will cause 'Request only valid for development instances' error"
            exit 1
          fi

      - name: Generate new token
        id: generate
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          SERVICE_USER_ID: ${{ secrets.SERVICE_USER_ID }}
        run: |
          cat > generate-token.mjs << 'EOF'
          import { createClerkClient } from '@clerk/backend';
          import { writeFileSync } from 'fs';

          async function main() {
            const clerkSecretKey = process.env.CLERK_SECRET_KEY;
            const serviceUserId = process.env.SERVICE_USER_ID;
            const tokenExpirationSeconds = 2592000; // 30 days

            if (!clerkSecretKey) {
              throw new Error('Missing Clerk Secret Key - CLERK_SECRET_KEY environment variable not set');
            }

            if (!serviceUserId) {
              throw new Error('Missing Service User ID - SERVICE_USER_ID environment variable not set');
            }

            console.log('Creating Clerk client...');
            const clerk = createClerkClient({
              secretKey: clerkSecretKey
            });

            try {
              // Step 1: Create a session for the service user
              console.log('Creating session for user:', serviceUserId);
              const sessionData = await clerk.sessions.createSession({
                userId: serviceUserId,
              });

              if (!sessionData || !sessionData.id) {
                throw new Error('Failed to create session - no session ID returned');
              }

              console.log('✓ Session created successfully');
              console.log('Session ID:', sessionData.id);

              // Step 2: Get JWT token from the session
              console.log('Generating JWT token from session...');
              const tokenData = await clerk.sessions.getToken(
                sessionData.id,
                undefined,  // template (optional)
                tokenExpirationSeconds
              );

              if (!tokenData || !tokenData.jwt) {
                throw new Error('No JWT token returned from Clerk API');
              }

              console.log('✓ JWT token generated successfully');

              const expiresAt = new Date(
                Date.now() + tokenExpirationSeconds * 1000
              ).toISOString();
              console.log('Token expires at:', expiresAt);

              // Write to GitHub output file
              writeFileSync(process.env.GITHUB_OUTPUT, `NEW_TOKEN=${tokenData.jwt}\n`, { flag: 'a' });
              writeFileSync(process.env.GITHUB_OUTPUT, `EXPIRES_AT=${expiresAt}\n`, { flag: 'a' });
            } catch (apiError) {
              console.error('Clerk API Error:', apiError.message);
              if (apiError.clerkError) {
                console.error('Clerk Error Details:', apiError.errors);
              }
              throw apiError;
            }
          }

          main().catch(e => {
            console.error('Error:', e.message);
            process.exit(1);
          });
          EOF

          npm install @clerk/backend
          node generate-token.mjs

      - name: Update Cloudflare Secret
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEW_TOKEN: ${{ steps.generate.outputs.NEW_TOKEN }}
        run: |
          # Update via wrangler
          echo "${{ steps.generate.outputs.NEW_TOKEN }}" | wrangler secret put CLERK_REFRESH_TOKEN --env production

      - name: Redeploy Worker
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install
          npm run deploy -- --env production

      - name: Notify on Success
        if: success()
        run: |
          echo "✓ Token rotated and worker redeployed"
          echo "Environment: production"
          echo "Expires: ${{ steps.generate.outputs.EXPIRES_AT }}"
          echo "Token type: Session JWT (compatible with backend API)"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "✗ Token rotation failed"
          echo "Check logs for details"
          exit 1
