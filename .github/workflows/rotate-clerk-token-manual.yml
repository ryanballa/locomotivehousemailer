name: Manual Clerk Token Rotation

on:
  workflow_dispatch:

jobs:
  manual-rotate:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Validate secrets
        run: |
          echo "Checking for CLERK_SECRET_KEY..."
          if [ -z "${{ secrets.CLERK_SECRET_KEY }}" ]; then
            echo "❌ Error: CLERK_SECRET_KEY secret is not set"
            echo "Available secrets context keys:"
            echo "${{ toJSON(secrets) }}" | grep -o '"[^"]*":' | head -20
            exit 1
          fi
          echo "✓ CLERK_SECRET_KEY is set"

          # Show first few characters to verify it's a production key
          KEY="${{ secrets.CLERK_SECRET_KEY }}"
          echo "Key type: ${KEY:0:8}..."
          if [[ $KEY == sk_live_* ]]; then
            echo "✓ Using PRODUCTION Clerk key"
          elif [[ $KEY == sk_test_* ]]; then
            echo "⚠ WARNING: Using TEST/DEVELOPMENT Clerk key (should use sk_live_)"
          fi

          echo "Checking for SERVICE_USER_ID..."
          if [ -z "${{ secrets.SERVICE_USER_ID }}" ]; then
            echo "❌ Error: SERVICE_USER_ID secret is not set"
            exit 1
          fi
          echo "✓ SERVICE_USER_ID is set"

          echo "✓ All required secrets are configured"

      - name: Check key type
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
        run: |
          # Extract first 8 characters to check key type
          KEY_PREFIX=$(echo "$CLERK_SECRET_KEY" | cut -c1-8)
          echo "Secret key prefix: $KEY_PREFIX"
          if [[ "$KEY_PREFIX" == "sk_live_" ]]; then
            echo "✓ Using PRODUCTION Clerk key (sk_live_)"
          elif [[ "$KEY_PREFIX" == "sk_test_" ]]; then
            echo "⚠ WARNING: Using TEST/DEVELOPMENT Clerk key (sk_test_)"
            echo "This will cause 'Request only valid for development instances' error"
            exit 1
          fi

      - name: Generate new token
        id: generate
        env:
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          SERVICE_USER_ID: ${{ secrets.SERVICE_USER_ID }}
        run: |
          cat > generate-token.mjs << 'EOF'
          import { createClerkClient } from '@clerk/backend';
          import { writeFileSync } from 'fs';

          async function main() {
            const clerkSecretKey = process.env.CLERK_SECRET_KEY;
            const serviceUserId = process.env.SERVICE_USER_ID;

            if (!clerkSecretKey) {
              throw new Error('Missing Clerk Secret Key - CLERK_SECRET_KEY environment variable not set');
            }

            if (!serviceUserId) {
              throw new Error('Missing Service User ID - SERVICE_USER_ID environment variable not set');
            }

            console.log('Creating Clerk client...');
            const clerk = createClerkClient({
              secretKey: clerkSecretKey
            });

            // Try different methods to generate token
            let token;

            try {
              // Method 1: Try creating a session first (works with test instances)
              console.log('Method 1: Creating session for user:', serviceUserId);
              try {
                const sessionData = await clerk.sessions.createSession({
                  userId: serviceUserId
                });

                console.log('Session created:', sessionData.id);

                // Get token from session
                console.log('Getting token from session...');
                token = await clerk.sessions.getToken(
                  sessionData.id,
                  undefined,
                  2592000
                );
              } catch (method1Error) {
                console.log('Method 1 failed:', method1Error.message);
                console.log('Trying alternative method...');

                // Method 2: Try getting user and creating token directly
                console.log('Method 2: Getting user and creating token directly');
                const user = await clerk.users.getUser(serviceUserId);
                console.log('User retrieved:', user.id);

                // Try to get/create a session directly
                const sessions = await clerk.users.getUserSessions(serviceUserId);
                console.log('User sessions:', sessions.length);

                if (sessions.length > 0) {
                  token = await clerk.sessions.getToken(
                    sessions[0].id,
                    undefined,
                    2592000
                  );
                  console.log('Token from existing session');
                } else {
                  throw new Error('No sessions found for user and could not create one');
                }
              }

              if (!token || !token.jwt) {
                throw new Error('No token returned from Clerk API');
              }

              console.log('✓ Token generated successfully');

              // Write to GitHub output file
              writeFileSync(process.env.GITHUB_OUTPUT, `NEW_TOKEN=${token.jwt}\n`, { flag: 'a' });
            } catch (apiError) {
              console.error('Clerk API Error:', apiError.message);
              if (apiError.errors) {
                console.error('Error details:', apiError.errors);
              }
              throw apiError;
            }
          }

          main().catch(e => {
            console.error('Error:', e.message);
            process.exit(1);
          });
          EOF

          npm install @clerk/backend
          node generate-token.mjs

      - name: Update Cloudflare Secret
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          NEW_TOKEN: ${{ steps.generate.outputs.NEW_TOKEN }}
        run: |
          # Update via wrangler
          echo "${{ steps.generate.outputs.NEW_TOKEN }}" | wrangler secret put CLERK_REFRESH_TOKEN --env ${{ github.event.inputs.environment }}

      - name: Redeploy Worker
        if: success()
        run: |
          npm install
          npm run deploy

      - name: Notify on Success
        if: success()
        run: |
          echo "✓ Token rotated and worker redeployed"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Expires: $(date -u -d '+30 days' +'%Y-%m-%dT%H:%M:%SZ')"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "✗ Token rotation failed"
          echo "Check logs for details"
          exit 1
